<div class="dashboard-layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">
      <img src="/assets/LogoDigital.png" class="logo-img" />
    </div>

    <nav>
      <ul class="nav-list">
        <li class="nav-item">
          <a class="nav-link" routerLink="/teacher/home" [ngClass]="{'nav-link-active': activeLink==='home'}"
            (click)="setActive('home')">
            <i class="bi bi-speedometer2"></i> Inicio
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link" routerLink="/teacher/mis-cursos" [ngClass]="{'nav-link-active': activeLink==='courses'}"
            (click)="setActive('courses')">
            <i class="bi bi-journal-richtext"></i> Mis Cursos
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link" routerLink="/teacher/progreso" [ngClass]="{'nav-link-active': activeLink==='students'}"
            (click)="setActive('students')">
            <i class="bi bi-people-fill"></i> Progreso Estudiantes
          </a>
        </li>
      </ul>
    </nav>
  </aside>


  <!-- MAIN WRAPPER -->
  <div class="main-wrapper">

    <!-- USER MENU -->
    <div class="user-menu-wrapper">
      <div class="user-menu" (click)="toggleUserMenu()">
        <div class="user-avatar">
          <img src="https://placehold.co/35x35/FF7E00/fff?text=P">
        </div>
        <span>Profesor</span>
        <i class="bi bi-chevron-down" [class.rotate]="userMenuOpen"></i>
      </div>

      <div class="user-dropdown-menu" [class.visible]="userMenuOpen">
        <a class="dropdown-item logout" (click)="logout()">
          <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
        </a>
      </div>
    </div>

    <!-- TITULO -->
    <div class="builder-container">
      <h2 class="title-builder">Estructura del Curso</h2>

      <div class="add-module-top">
        <button class="btn-add-module" (click)="abrirModalNuevoModulo()">
          + Nuevo Módulo
        </button>
      </div>


      <!-- LISTA DE MÓDULOS -->
      <div class="module-list">

        <div class="module-card" *ngFor="let modulo of modulos; let mi = index">

          <!-- HEADER MÓDULO -->
          <div class="module-header">
            <div>
              <span class="module-tag">Semana {{ mi + 1 }}</span>
              <h3 class="module-title">{{ modulo.titulo }}</h3>

              <p class="module-desc" *ngIf="modulo.descripcion">{{ modulo.descripcion }}</p>
            </div>

            <div class="module-actions">
              <button class="btn-icon" (click)="abrirModalModulo(mi)">
                <i class="bi bi-pencil-square"></i>
              </button>

              <button class="btn-icon danger" (click)="eliminarModulo(mi)">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>

          <!-- LECCIONES -->
          <div class="lessons-container">

            <div class="lesson-item" *ngFor="let lec of modulo.lecciones; let li = index">

              <div class="lesson-header">
                <div>
                  <div class="lesson-title">{{ lec.titulo || 'Lección ' + (li+1) }}</div>
                  <div class="lesson-desc" *ngIf="lec.descripcion">{{ lec.descripcion }}</div>
                </div>

                <div class="lesson-actions">
                  <button class="btn-icon" (click)="abrirModalLeccion(mi, li)">
                    <i class="bi bi-pencil-square"></i>
                  </button>

                  <button class="btn-icon danger" (click)="eliminarLeccion(mi, li)">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>

              <!-- BOTONES DENTRO DE LECCIÓN -->
              <div class="lesson-inline-actions">
                <button class="btn-add-small" (click)="agregarMaterialExistente(mi, li)">
                  + Material
                </button>

                <button class="btn-add-small" (click)="agregarQuizExistente(mi, li)">
                  + Quiz
                </button>
              </div>


              <!-- LISTA DE MATERIALES -->
              <ul class="material-list" *ngIf="lec.materiales?.length">

                <li class="material-row" *ngFor="let mat of lec.materiales; let mati=index">

                  <div class="material-left">
                    <i class="bi" [ngClass]="{
                        'bi-file-earmark-pdf': mat.tipo==='PDF',
                        'bi-play-btn-fill': mat.tipo==='VIDEO',
                        'bi-question-circle': mat.tipo==='QUIZ'
                      }"></i>

                    <div class="material-title">
                      {{ mat.tipo }} — {{ mat.url | slice:0:60 }}
                    </div>
                  </div>

                  <div class="material-actions">
                    <button class="btn-icon" (click)="abrirModalMaterial(mi, li, mati)">
                      <i class="bi bi-pencil-square"></i>
                    </button>

                    <button class="btn-icon danger" (click)="eliminarMaterial(mi, li, mati)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>

                </li>

              </ul>

              <!-- QUIZ LIST -->
              <div class="quiz-list" *ngIf="lec.evaluaciones?.length">

                <div class="quiz-row" *ngFor="let q of lec.evaluaciones; let qi = index">

                  <div class="quiz-left">
                    <i class="bi bi-check2-square"></i>

                    <div>
                      <div class="quiz-question">{{ q.pregunta }}</div>

                      <div class="quiz-meta">
                        A: {{q.opcionA}} ·
                        B: {{q.opcionB}} ·
                        C: {{q.opcionC}} ·
                        D: {{q.opcionD}} ·
                        Correcta: {{q.respuestaCorrecta}}
                      </div>
                    </div>
                  </div>

                  <div class="quiz-actions">
                    <button class="btn-icon" (click)="abrirModalQuiz(mi, li, qi)">
                      <i class="bi bi-pencil-square"></i>
                    </button>

                    <button class="btn-icon danger" (click)="eliminarQuiz(mi, li, qi)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>

                </div>

              </div>

            </div>

            <!-- AGREGAR NUEVA LECCIÓN -->
            <button class="btn-add-small btn-add-lesson" (click)="agregarLeccionExistente(mi)">
              + Agregar nueva lección
            </button>

          </div>

        </div>

      </div>

    </div>


    <!-- MODAL EDICIÓN -->
    <div class="modal-backdrop" *ngIf="editModalVisible">
      <div class="edit-modal">

        <h3>{{ editTitle }}</h3>

        <!-- CONTROLLER DEL MODAL -->
        <ng-container *ngIf="editContext as ctx">

          <!-- MODULO / LECCIÓN -->
          <div *ngIf="ctx.tipo==='modulo' || ctx.tipo==='leccion' || ctx.tipo==='nuevoModulo'">
            <label>Título</label>
            <input class="input-main" [(ngModel)]="editData.titulo">

            <label>Descripción</label>
            <textarea class="input-main textarea" [(ngModel)]="editData.descripcion"></textarea>
          </div>


          <!-- MATERIAL -->
          <div *ngIf="ctx.tipo==='material'">

            <label>Tipo de material</label>
            <select class="select-material" [(ngModel)]="editData.tipo" (change)="onMaterialTypeChange()">
              <option value="PDF">PDF</option>
              <option value="VIDEO">VIDEO</option>
            </select>

            <!-- PDF -->
            <div *ngIf="editData.tipo==='PDF'">
              <label>Subir archivo PDF</label>
              <input type="file" accept="application/pdf" (change)="onFileSelected($event)">
              <p *ngIf="editData.url">Archivo actual: {{editData.url}}</p>
            </div>

            <!-- VIDEO -->
            <div *ngIf="editData.tipo==='VIDEO'">
              <label>URL Video</label>
              <input class="input-main" [(ngModel)]="editData.url">
            </div>

          </div>


          <!-- QUIZ -->
          <div *ngIf="ctx.tipo==='quiz'" class="quiz-modal">
            <label>Pregunta</label>
            <input class="input-main" [(ngModel)]="editData.pregunta">

            <label>Opción A</label>
            <input class="input-main" [(ngModel)]="editData.opcionA">

            <label>Opción B</label>
            <input class="input-main" [(ngModel)]="editData.opcionB">

            <label>Opción C</label>
            <input class="input-main" [(ngModel)]="editData.opcionC">

            <label>Opción D</label>
            <input class="input-main" [(ngModel)]="editData.opcionD">

            <label>Correcta</label>
            <select class="select-material" [(ngModel)]="editData.respuestaCorrecta">
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
            </select>
          </div>

        </ng-container>

        <!-- BOTONES MODAL -->
        <div class="modal-actions">
          <button class="btn-save" (click)="guardarEdicion()">Guardar</button>
          <button class="btn-cancel" (click)="cerrarModal()">Cancelar</button>
        </div>

      </div>
    </div>

  </div>

</div>