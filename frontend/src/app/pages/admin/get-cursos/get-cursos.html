<div class="dashboard-layout">
    <aside class="sidebar">
        <div class="logo">
            <img src="/assets/LogoDigital.png" alt="Logo Digital Academy" class="logo-img" />
        </div>
        <nav>
            <ul class="nav-list">
                <li class="nav-item">
                    <a class="nav-link" routerLink="/admin/home"
                        [ngClass]="{'nav-link-active': activeLink==='home', 'nav-link-inactive': activeLink!=='home'}"
                        (click)="setActive('home')">
                        <i class="bi bi-house-fill nav-icon"></i>
                        <span>Home</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" routerLink="/admin/getUsuario"
                        [ngClass]="{'nav-link-active': activeLink==='gestion-usuarios', 'nav-link-inactive': activeLink!=='gestion-usuarios'}"
                        (click)="setActive('gestion-usuarios')">
                        <i class="bi bi-people-fill nav-icon"></i>
                        <span>Gestión Usuarios</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" routerLink="/admin/getCursos"
                        [ngClass]="{'nav-link-active': activeLink==='gestion-cursos', 'nav-link-inactive': activeLink!=='gestion-cursos'}"
                        (click)="setActive('gestion-cursos')">
                        <i class="bi bi-journal-bookmark-fill nav-icon"></i>
                        <span>Gestión Cursos</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" routerLink="/admin/reportesProgresos"
                        [ngClass]="{'nav-link-active': activeLink==='reportes', 'nav-link-inactive': activeLink!=='reportes'}"
                        (click)="setActive('reportes')">
                        <i class="bi bi-graph-up-arrow nav-icon"></i>
                        <span>Reportes y Progreso</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <div class="main-wrapper">

        <div class="top-bar">
            <h1 class="page-title">GESTIÓN CURSOS</h1>
            <div class="user-menu-wrapper">
                <div class="user-menu" (click)="toggleUserMenu()">
                    <div class="user-avatar">
                        <img src="https://placehold.co/35x35/4A90E2/ffffff?text=A" alt="Avatar">
                    </div>
                    <span class="user-info">{{ adminNombreCompleto }}</span>
                    <i class="bi bi-chevron-down" [class.rotate]="userMenuOpen"></i>
                </div>
                <div class="user-dropdown-menu" [class.visible]="userMenuOpen">
                    <a class="dropdown-item logout" (click)="logout()">
                        <i class="bi bi-box-arrow-right"></i>
                        <span>Cerrar Sesión</span>
                    </a>
                </div>
            </div>
        </div>

        <div class="gestion-cursos-container">

            <div class="cursos-top-actions">
                <div class="cursos-search-bar">
                    <input type="text" placeholder="Búsqueda por nombre o editor responsable." class="search-input">
                    <button class="btn-primary-action btn-search">
                        <i class="bi bi-search"></i>
                        Buscar
                    </button>
                </div>

                <button class="btn-primary-action btn-add-course" (click)="openAddCourseModal()">
                    <i class="bi bi-plus-lg"></i>
                    Agregar Curso
                </button>
            </div>

            <div class="cursos-grid">

                <div class="course-card-add-new" (click)="openAddCourseModal()">
                    <div class="add-icon">
                        <i class="bi bi-plus-lg"></i>
                    </div>
                </div>

                <div class="course-card" *ngFor="let curso of cursos">
                    <div class="card-category">{{ curso.categoriaNombre || 'Sin categoría' }}</div>

                    <!-- IMAGEN ACTUALIZADA CON CACHE -->
                    <img [src]="getImageUrl(curso.imagenUrl)" 
                         [alt]="'Portada de ' + curso.titulo" 
                         class="card-image"
                         (load)="onImageLoad()"
                         (error)="onImageError($event, curso)">

                    <div class="card-body">
                        <h4 class="course-title">{{ curso.titulo }}</h4>
                        <p class="course-editor">{{ curso.editorNombre || 'Sin editor' }}</p>
                        <div class="course-meta">
                            <span><i class="bi bi-book-fill"></i> {{ curso.modulos?.length || 0 }}</span>
                        </div>
                        <div class="course-actions">
                            <i class="bi bi-pencil-square action-edit" (click)="editarCursoModal(curso)"></i>
                            <i class="bi bi-trash3 action-delete" (click)="eliminarCurso(curso.id)"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL AGREGAR CURSO -->
<div class="modal-overlay" [style.display]="modalOpen ? 'flex' : 'none'">
    <div class="modal-card modal-agregar-curso">
        <h3 class="modal-title">{{ modalTitle }}</h3>
        <button class="btn-eye-toggle close-button" (click)="closeModal()">
            <i class="bi bi-x-lg"></i>
        </button>

        <div class="upload-area" (click)="triggerFileInput()">
            <i class="bi bi-cloud-upload-fill"></i>
            <p>Subir portada del Curso</p>
            <div *ngIf="selectedFile" class="selected-file">
                <i class="bi bi-check-circle-fill text-success"></i>
                {{ selectedFile.name }}
            </div>
        </div>

        <input type="file" #fileInput accept="image/*" style="display:none" (change)="onFileSelected($event)">

        <div class="modal-form-grid">

            <div class="form-group full-width">
                <label for="new-nombre">Nombre</label>
                <input type="text" id="new-nombre" [(ngModel)]="titulo" placeholder="Ingresa el nombre del curso">
            </div>

            <div class="form-group full-width">
                <label for="new-descripcion">Descripción</label>
                <textarea id="new-descripcion" rows="3" [(ngModel)]="descripcion"
                    placeholder="Ingresa la descripción del curso"></textarea>
            </div>

            <div class="form-group full-width">
                <label for="new-categoria">Categoría</label>
                <div class="custom-select-wrapper">
                    <select id="new-categoria" [(ngModel)]="categoriaId" name="categoriaId">
                        <option value="" disabled selected>Selecciona una categoría</option>
                        <option *ngFor="let cat of categorias" [value]="cat.id">
                            {{ cat.nombre }}
                        </option>
                    </select>
                </div>
                <div *ngIf="categorias.length === 0" class="debug-info">
                    <small class="text-warning">No hay categorías disponibles</small>
                </div>
                <div *ngIf="categorias.length > 0" class="debug-info">
                    <small class="text-success">{{ categorias.length }} categorías cargadas</small>
                </div>
            </div>

            <div class="form-group full-width">
                <label for="new-editor">Editor Responsable</label>
                <div class="custom-select-wrapper">
                    <select id="new-editor" [(ngModel)]="editorId" name="editorId">
                        <option value="" disabled selected>Selecciona un editor</option>
                        <option *ngFor="let editor of editores" [value]="editor.id">
                            {{ editor.nombre }}
                        </option>
                    </select>
                </div>
                <div *ngIf="editores.length === 0" class="debug-info">
                    <small class="text-warning">No hay editores disponibles</small>
                </div>
                <div *ngIf="editores.length > 0" class="debug-info">
                    <small class="text-success">{{ editores.length }} editores cargados</small>
                </div>
            </div>

        </div>

        <button class="btn-primary-action btn-modal-create" (click)="editandoId ? guardarEdicion() : crearCurso()"
            [disabled]="!titulo || !descripcion || !categoriaId || !editorId">
            {{ editandoId ? 'GUARDAR CAMBIOS' : 'CREAR CURSO' }}
        </button>

    </div>
</div>